#V2
-- This enables proper migration state management per database
-- ########################################################
-- Migration Tracking Table
-- ########################################################
-- Create the migration_history table to track applied migrations
DEFINE TABLE migration_history SCHEMAFULL;
-- Migration tracking fields
DEFINE FIELD migration_number ON migration_history TYPE string;
DEFINE FIELD migration_name ON migration_history TYPE string;
DEFINE FIELD migration_file ON migration_history TYPE string;
DEFINE FIELD applied_at ON migration_history TYPE datetime DEFAULT time::now();
DEFINE FIELD applied_by ON migration_history TYPE option<string>;
DEFINE FIELD checksum ON migration_history TYPE option<string>;
DEFINE FIELD execution_time_ms ON migration_history TYPE option<int>;
-- Create indexes for the migration_history table
DEFINE INDEX migration_history_number ON migration_history FIELDS migration_number UNIQUE;
DEFINE INDEX migration_history_applied_at ON migration_history FIELDS applied_at;
DEFINE INDEX migration_history_name ON migration_history FIELDS migration_name;
-- Record this migration as applied
CREATE migration_history:0001 SET    migration_number = "0001",    migration_name = "migration_tracking",    migration_file = "0001_migration_tracking_up.surql",    applied_at = time::now(),    applied_by = "migration_script",    checksum = "initial";
    CREATE migration_history SET        migration_number = '0001',        migration_name = 'migration_tracking',        migration_file = '0001_migration_tracking_up.surql',        applied_at = time::now(),        applied_by = 'migration_script',        execution_time_ms = 8891;
    
REMOVE TABLE health_check;
REMOVE TABLE migration_history;
REMOVE TABLE health_check;
REMOVE TABLE migration_history;
USE NAMESPACE idance;
USE DATABASE local;
DEFINE TABLE health_check SCHEMAFULL;
DEFINE FIELD created_at ON TABLE health_check TYPE datetime DEFAULT time::now();
CREATE health_check SET created_at = time::now();
SELECT * FROM health_check;
SELECT * FROM migration_history WHERE migration_number = '0001';
DEFINE TABLE migration_history SCHEMAFULL;
DEFINE FIELD migration_number ON migration_history TYPE string;
DEFINE FIELD migration_name ON migration_history TYPE string;
DEFINE FIELD migration_file ON migration_history TYPE string;
DEFINE FIELD applied_at ON migration_history TYPE datetime DEFAULT time::now();
DEFINE FIELD applied_by ON migration_history TYPE option<string>;
DEFINE FIELD checksum ON migration_history TYPE option<string>;
DEFINE FIELD execution_time_ms ON migration_history TYPE option<int>;
DEFINE INDEX migration_history_number ON migration_history FIELDS migration_number UNIQUE;
DEFINE INDEX migration_history_applied_at ON migration_history FIELDS applied_at;
DEFINE INDEX migration_history_name ON migration_history FIELDS migration_name;
CREATE migration_history:0001 SET migration_number = "0001", migration_name = "migration_tracking", migration_file = "0001_migration_tracking_up.surql", applied_at = time::now(), applied_by = "migration_script", checksum = "initial";
    CREATE migration_history SET        migration_number = '0001',        migration_name = 'migration_tracking',        migration_file = '0001_migration_tracking_up.surql',        applied_at = time::now(),        applied_by = 'migration_script',        execution_time_ms = 34854;
    
SELECT * FROM migration_history;
SELECT * FROM migration_history WHERE migration_number = '0001';
REMOVE TABLE migration_history;
    DELETE FROM migration_history WHERE migration_number = '0001';
    
SELECT * FROM migration_history WHERE migration_number = '0001';
DEFINE TABLE migration_history SCHEMAFULL;
DEFINE FIELD migration_number ON migration_history TYPE string;
DEFINE FIELD migration_name ON migration_history TYPE string;
DEFINE FIELD migration_file ON migration_history TYPE string;
DEFINE FIELD applied_at ON migration_history TYPE datetime DEFAULT time::now();
DEFINE FIELD applied_by ON migration_history TYPE option<string>;
DEFINE FIELD checksum ON migration_history TYPE option<string>;
DEFINE FIELD execution_time_ms ON migration_history TYPE option<int>;
DEFINE INDEX migration_history_number ON migration_history FIELDS migration_number UNIQUE;
DEFINE INDEX migration_history_applied_at ON migration_history FIELDS applied_at;
DEFINE INDEX migration_history_name ON migration_history FIELDS migration_name;
CREATE migration_history:0001 SET migration_number = "0001", migration_name = "migration_tracking", migration_file = "0001_migration_tracking_up.surql", applied_at = time::now(), applied_by = "migration_script", checksum = "initial";
    CREATE migration_history SET        migration_number = '0001',        migration_name = 'migration_tracking',        migration_file = '0001_migration_tracking_up.surql',        applied_at = time::now(),        applied_by = 'migration_script',        execution_time_ms = 34832;
    
REMOVE TABLE health_check;
REMOVE TABLE migration_history;
INFO FOR DB;
REMOVE TABLE user_dance_style;
REMOVE TABLE vlog;
REMOVE TABLE chat;
REMOVE TABLE user;
REMOVE TABLE group;
REMOVE TABLE country;
REMOVE TABLE migration_history;
REMOVE TABLE health_check;
SELECT * FROM migration_history WHERE migration_number = '0001';
DEFINE TABLE migration_history SCHEMAFULL;
DEFINE FIELD migration_number ON migration_history TYPE string;
DEFINE FIELD migration_name ON migration_history TYPE string;
DEFINE FIELD migration_file ON migration_history TYPE string;
DEFINE FIELD applied_at ON migration_history TYPE datetime DEFAULT time::now();
DEFINE FIELD applied_by ON migration_history TYPE option<string>;
DEFINE FIELD checksum ON migration_history TYPE option<string>;
DEFINE FIELD execution_time_ms ON migration_history TYPE option<int>;
DEFINE INDEX migration_history_number ON migration_history FIELDS migration_number UNIQUE;
DEFINE INDEX migration_history_applied_at ON migration_history FIELDS applied_at;
DEFINE INDEX migration_history_name ON migration_history FIELDS migration_name;
CREATE migration_history:0001 SET migration_number = "0001", migration_name = "migration_tracking", migration_file = "0001_migration_tracking_up.surql", applied_at = time::now(), applied_by = "migration_script", checksum = "initial";
    CREATE migration_history SET        migration_number = '0001',        migration_name = 'migration_tracking',        migration_file = '0001_migration_tracking_up.surql',        applied_at = time::now(),        applied_by = 'migration_script',        execution_time_ms = 34548;
    
SELECT * FROM migration_history WHERE migration_number = '0001';
REMOVE TABLE migration_history;
    DELETE FROM migration_history WHERE migration_number = '0001';
    
INFO FOR DB;
SELECT * FROM health_check LIMIT 5;
SELECT * FROM migration_history;
